<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="article-icons.html">

<!--
Element providing tools relating to an article.

##### Example

  <article>
    <article-tools url="http://example.com/"></article-tools>
  </article>

@element article-tools
@blurb Element providing tools related to an article.
@status alpha
@homepage https://github.com/peerj/article-tools
-->
<polymer-element name="article-tools" attributes="url github">
  <template>
    <link rel="stylesheet" href="article-tools.css">

    <div layout horizontal>
      <div flex layout horizontal start-justified class="article-tools article-tools-annotate"
        on-mouseover="{{ showAnnotationTools }}"
        on-mouseout="{{ unShowAnnotationTools }}"
        hidden?="{{ !hideShareTools }}">

        <span class="article-tool article-tool-control"
          title="Annotate this article"
          on-tap="{{ toggleAnnotationTools }}"><core-icon icon="article:comment"></core-icon></span>

        <a class="article-tool" hidden?="{{ hideAnnotationTools }}" target="_blank"
          title="Annotate this article with hypothes.is"
          href="{{ hypothesisURL }}"><span class="article-tool-text">Annotate in Hypothesis</span></a>

        <a class="article-tool" hidden?="{{ hideAnnotationTools }}" target="_blank"
          title="Annotate this article with Genius"
          href="{{ geniusURL }}"><span class="article-tool-text">Annotate in Genius</span></a>

        <template if="{{ publonsURL }}">
          <a class="article-tool" hidden?="{{ hideAnnotationTools }}" target="_blank"
            title="Review this article in Publons"
            href="{{ publonsURL }}"><span class="article-tool-text">Review in Publons</span></a>
        </template>
      </div>

      <div flex layout horizontal end-justified class="article-tools article-tools-share"
        on-mouseover="{{ showShareTools }}"
        on-mouseout="{{ unShowShareTools }}"
        hidden?="{{ !hideAnnotationTools }}">

        <a class="article-tool" hidden?="{{ hideShareTools }}" target="_blank"
          title="Email this article"
          href="{{ emailURL }}"><core-icon icon="article:email"></core-icon></a>

        <a class="article-tool" hidden?="{{ hideShareTools }}" target="_blank"
          title="Share this article on Twitter"
          href="{{ twitterURL }}"><core-icon icon="article:post-twitter"></core-icon></a>

        <a class="article-tool" hidden?="{{ hideShareTools }}" target="_blank"
          title="Share this article on Facebook"
          href="{{ facebookURL }}"><core-icon icon="article:post-facebook"></core-icon></a>

        <a class="article-tool" hidden?="{{ hideShareTools }}" target="_blank"
          title="Share this article on Google+"
          href="{{ googlePlusURL }}"><core-icon icon="article:post-gplus"></core-icon></a>

        <template if="{{ github }}">
          <a class="article-tool" hidden?="{{ hideShareTools }}" target="_blank"
            title="Fork this article on GitHub"
            href="https://github.com/{{ github }}"><core-icon icon="article:post-github"></core-icon></a>
        </template>

        <span class="article-tool article-tool-control"
          title="Share this article"
          on-tap="{{ toggleShareTools }}"><core-icon icon="article:share"></core-icon></span>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      hideShareTools: true,
      hideAnnotationTools: true,
      calculateWidth: function() {
        this.style.right = $('html /deep/ .column-main').css('right');
      },
      domReady: function() {
        this.calculateWidth();
        $(window).on('resize', this.calculateWidth.bind(this));
      },
      toggleShareTools: function() {
        this.hideAnnotationTools = true;
        this.hideShareTools = !this.hideShareTools;
      },
      toggleAnnotationTools: function() {
        this.hideShareTools = true;
        this.hideAnnotationTools = !this.hideAnnotationTools;
      },
      showShareTools: function() {
        this.hideAnnotationTools = true;
        this.hideShareTools = false;
      },
      showAnnotationTools: function() {
        this.hideShareTools = true;
        this.hideAnnotationTools = false;
      },
      unShowShareTools: function() {
        this.hideShareTools = true;
      },
      unShowAnnotationTools: function() {
        this.hideAnnotationTools = true;
      },
      urlChanged: function() {
        this.twitterURL = 'https://twitter.com/intent/tweet?' + $.param({
          url: this.url
        });

        this.googlePlusURL = 'https://plus.google.com/share?' + $.param({
          url: this.url
        });

        this.facebookURL = 'https://www.facebook.com/dialog/share?' + $.param({
          redirect_uri: 'https://peerj.github.io/article-tools/close.html',
          app_id: '374861959379602',
          display: 'popup',
          href: this.url,
        });

        // TODO: subject line, title and content?
        this.emailURL = 'mailto:?' + $.param({
          body: this.url
        });

        this.hypothesisURL = 'https://via.hypothes.is/' + this.url;
        this.geniusURL = 'https://genius.it/' + this.url;

        var meta = {
          doi: $('meta[name=citation_doi]').attr('content'),
          title: $('header h1').text()
        };

        if (meta.doi && meta.title) {
          this.publonsURL = 'https://publons.com/review/create/post/?' + $.param({
            article_doi: meta.doi,
            article_title: meta.title,
          })
        }
      }
    });
  </script>
</polymer-element>
